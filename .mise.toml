[tools]
node = "24.11.1"
bun = "1.3.5"

[env]
NODE_OPTIONS      = "--no-deprecation"
PROD_COMPOSE_ARGS = "--env-file .env.production -f compose.prod.yaml"

[tasks.install]
description = "ロックファイルに変更があった場合のみ依存関係をインストール"
run         = "bun install"
sources     = ["package.json", "bun.lock"]

[tasks."dev:db"]
description = "PostgreSQL (DB) のみを開始"
run         = "docker compose up -d postgres"

[tasks."dev:db:stop"]
description = "PostgreSQL を停止"
run         = "docker compose stop postgres"

[tasks."reset:db"]
description = "開発用DBのデータを削除して作り直す（リセット）"
run = """
set -euo pipefail
docker compose down -v
docker compose up -d postgres
"""

[tasks.dev]
depends = ["install"]
description = "DockerとNext.jsサーバーを起動 (Ctrl+C終了時にコンテナも自動停止)"
run = """
set -euo pipefail
docker compose up -d
cleanup() {
    docker compose stop
}
trap cleanup EXIT
trap '' INT
set +e
bun run dev
EXIT_CODE=$?
set -e
if [ "$EXIT_CODE" -eq 130 ] || [ "$EXIT_CODE" -eq 143 ]; then
    exit 0
fi
exit "$EXIT_CODE"
"""

[tasks."prod:up"]
description = "本番環境スタックをビルドして起動"
run         = "docker compose $PROD_COMPOSE_ARGS up -d --build"

[tasks."prod:down"]
description = "本番環境スタックを停止"
run         = "docker compose $PROD_COMPOSE_ARGS down"

[tasks."reset:db:prod"]
description = "本番用DBデータを削除して再構築"
run = """
set -euo pipefail
docker compose $PROD_COMPOSE_ARGS down -v
docker compose $PROD_COMPOSE_ARGS up -d --build
"""
